<template>
  <div
    class="stream-row bg-white border border-gray-200 rounded-lg shadow-sm transition-all duration-150"
    :class="{ 'hover:bg-gray-50 hover:shadow-md': !isExpanded }"
  >
    <!-- „É°„Ç§„É≥„ÅÆÊ≠åÊû†ÊÉÖÂ†± -->
    <div class="cursor-pointer" @click="toggleExpanded">
      <!-- „É¢„Éê„Ç§„É´Ë°®Á§∫ -->
      <div class="block md:hidden p-3">
        <div class="flex items-start space-x-3">
          <!-- „Çµ„É†„Éç„Ç§„É´Ôºà„É¢„Éê„Ç§„É´Ôºâ -->
          <div class="flex-shrink-0 w-[4.44rem] h-10">
            <div
              class="w-full h-full bg-gray-200 rounded border border-gray-300 flex items-center justify-center overflow-hidden"
            >
              <img
                v-if="stream.thumbnail_path"
                :src="stream.thumbnail_path"
                :alt="stream.title"
                class="w-full h-full object-cover"
                loading="lazy"
                @error="handleImageError"
              />
              <span v-else class="text-sm text-gray-400">üé§</span>
            </div>
          </div>

          <!-- Ê≠åÊû†ÊÉÖÂ†±Ôºà„É¢„Éê„Ç§„É´Ôºâ -->
          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between">
              <h3 class="text-xs font-medium text-gray-900 truncate mb-1">
                {{ stream.title }}
              </h3>
              <!-- Â±ïÈñã„Ç¢„Ç§„Ç≥„É≥ -->
              <button
                class="ml-2 p-1 text-gray-400 hover:text-gray-600"
                @click.stop="toggleExpanded"
              >
                <svg
                  class="w-4 h-4 transform transition-transform duration-200"
                  :class="{ 'rotate-180': isExpanded }"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  />
                </svg>
              </button>
            </div>
            <!-- „Éê„ÉÉ„Ç∏Ôºà„É¢„Éê„Ç§„É´Ôºâ -->
            <div class="flex flex-wrap gap-1 mb-2">
              <span
                v-if="stream.is_member_only"
                class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800"
              >
                „É°„É≥„Éê„ÉºÈôêÂÆö
              </span>
              <span
                v-if="!stream.is_open"
                class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800"
              >
                ÈùûÂÖ¨Èñã
              </span>
              <span v-if="stream.unplayable" class="text-xs text-red-500">
                ‚ö†Ô∏è ÂÜçÁîü‰∏çÂèØ
              </span>
            </div>
            <!-- Êó•ÊôÇÊÉÖÂ†±Ôºà„É¢„Éê„Ç§„É´Ôºâ -->
            <div class="flex items-center justify-between">
              <div class="text-xs text-gray-500">
                {{ formatDate(stream.published_at) }}
                <span
                  v-if="stream.songs_count !== undefined"
                  class="ml-1 text-gray-400"
                >
                  ‚Ä¢ {{ stream.songs_count }}Êõ≤
                </span>
              </div>
              <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥Ôºà„É¢„Éê„Ç§„É´Ôºâ -->
              <div class="flex items-center space-x-1">
                <!-- YouTube „ÅßÈñã„Åè -->
                <a
                  :href="stream.url"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="p-1 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors duration-150"
                  title="YouTube „ÅßÈñã„Åè"
                  @click.stop
                >
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path
                      d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"
                    />
                  </svg>
                </a>

                <!-- Ê≠åÊû†ÂÖ®‰Ωì„Çí„Ç≠„É•„Éº„Å´ËøΩÂä†„Éú„Çø„É≥ -->
                <button
                  class="p-1 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded transition-colors duration-150"
                  :class="{ 'animate-bounce text-green-600': addingToQueue }"
                  :title="getAddAllButtonTitle()"
                  :disabled="addingToQueue"
                  @click.stop="handleAddStreamToQueue"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                    />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- „Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóË°®Á§∫ -->
      <div class="hidden md:block p-4">
        <div class="flex items-center space-x-4">
          <!-- „Çµ„É†„Éç„Ç§„É´Ôºà„Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÔºâ -->
          <div class="flex-shrink-0 w-[6.67rem] h-[3.75rem]">
            <div
              class="w-full h-full bg-gray-200 rounded border border-gray-300 flex items-center justify-center overflow-hidden"
            >
              <img
                v-if="stream.thumbnail_path"
                :src="stream.thumbnail_path"
                :alt="stream.title"
                class="w-full h-full object-cover"
                loading="lazy"
                @error="handleImageError"
              />
              <span v-else class="text-gray-400">üé§</span>
            </div>
          </div>

          <!-- Ê≠åÊû†ÊÉÖÂ†±Ôºà„Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÔºâ -->
          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between">
              <h3 class="text-base font-medium text-gray-900 mb-2">
                {{ stream.title }}
              </h3>
              <!-- Â±ïÈñã„Ç¢„Ç§„Ç≥„É≥ -->
              <button
                class="ml-4 p-2 text-gray-400 hover:text-gray-600 rounded-full transition-colors"
                @click.stop="toggleExpanded"
              >
                <svg
                  class="w-5 h-5 transform transition-transform duration-200"
                  :class="{ 'rotate-180': isExpanded }"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  />
                </svg>
              </button>
            </div>

            <!-- „Éê„ÉÉ„Ç∏„Å®ÊÉÖÂ†±Ôºà„Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÔºâ -->
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <!-- „Éê„ÉÉ„Ç∏ -->
                <div class="flex flex-wrap gap-2">
                  <span
                    v-if="stream.is_member_only"
                    class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800"
                  >
                    „É°„É≥„Éê„ÉºÈôêÂÆö
                  </span>
                  <span
                    v-if="!stream.is_open"
                    class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800"
                  >
                    ÈùûÂÖ¨Èñã
                  </span>
                  <span v-if="stream.unplayable" class="text-sm text-red-500">
                    ‚ö†Ô∏è ÂÜçÁîü‰∏çÂèØ
                  </span>
                </div>

                <!-- Êó•ÊôÇÊÉÖÂ†± -->
                <div class="text-sm text-gray-500">
                  {{ formatDate(stream.published_at) }}
                  <span
                    v-if="stream.songs_count !== undefined"
                    class="ml-2 text-gray-400"
                  >
                    ‚Ä¢ {{ stream.songs_count }}Êõ≤
                  </span>
                </div>
              </div>

              <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥Ôºà„Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÔºâ -->
              <div class="flex items-center space-x-2">
                <!-- YouTube „ÅßÈñã„Åè -->
                <a
                  :href="stream.url"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors duration-150"
                  title="YouTube „ÅßÈñã„Åè"
                  @click.stop
                >
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path
                      d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"
                    />
                  </svg>
                </a>

                <!-- Ê≠åÊû†ÂÖ®‰Ωì„Çí„Ç≠„É•„Éº„Å´ËøΩÂä†„Éú„Çø„É≥ -->
                <button
                  class="p-2 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded-full transition-colors duration-150"
                  :class="{ 'animate-bounce text-green-600': addingToQueue }"
                  :title="getAddAllButtonTitle()"
                  :disabled="addingToQueue"
                  @click.stop="handleAddStreamToQueue"
                >
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                    />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Â±ïÈñã„Åï„Çå„ÅüÊ•ΩÊõ≤‰∏ÄË¶ß -->
    <div v-if="isExpanded" class="border-t border-gray-200 bg-gray-50">
      <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã -->
      <div v-if="loadingSongs" class="p-4 text-center">
        <div
          class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mb-2"
        ></div>
        <p class="text-sm text-gray-600">Ê•ΩÊõ≤„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
      </div>

      <!-- „Ç®„É©„ÉºÁä∂ÊÖã -->
      <div v-else-if="songsError" class="p-4 text-center">
        <p class="text-sm text-red-600 mb-2">{{ songsError }}</p>
        <button
          class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700"
          @click="loadStreamSongs"
        >
          ÂÜçË©¶Ë°å
        </button>
      </div>

      <!-- Ê•ΩÊõ≤‰∏ÄË¶ß -->
      <div v-else-if="streamSongs.length > 0" :class="SONG_ROW_STYLES.divider">
        <div
          v-for="song in streamSongs"
          :key="song.id"
          class="flex items-stretch p-0 min-h-[80px]"
        >
          <!-- Ê•ΩÊõ≤ÊÉÖÂ†±Ôºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÂÜçÁîüÔºâ -->
          <div
            class="flex-1 min-w-0 cursor-pointer py-4 pl-4"
            @click="handlePlayNow(song)"
          >
            <div :class="SONG_ROW_STYLES.info.titleContainer">
              <h3 :class="SONG_ROW_STYLES.info.titleDesktop">
                {{ song.title }}
              </h3>
              <span v-if="song.is_original" :class="SONG_ROW_STYLES.info.badge">
                „Ç™„É™„Ç∏„Éä„É´
              </span>
            </div>
            <p :class="SONG_ROW_STYLES.info.artistDesktop">
              {{ song.artist }}
            </p>
          </div>

          <!-- „Éú„Çø„É≥„Ç∞„É´„Éº„Éó -->
          <div
            :class="SONG_ROW_STYLES.menuButton.wrapperDesktop"
            class="flex items-center gap-2"
            @click.stop
          >
            <!-- „Ç≠„É•„Éº„Å´ËøΩÂä†„Éú„Çø„É≥ -->
            <button
              @click="handleAddToQueue(song)"
              class="p-2 hover:bg-green-50 rounded-lg transition-colors text-green-600 hover:text-green-700"
              title="„Ç≠„É•„Éº„Å´ËøΩÂä†"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 4v16m8-8H4"
                />
              </svg>
            </button>
            <!-- „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„Éº„Éú„Çø„É≥ -->
            <button
              :class="SONG_ROW_STYLES.menuButton.buttonDesktop"
              @click.stop="openMenu(song.id, $event)"
              :aria-label="`${song.title}„ÅÆ„É°„Éã„É•„Éº`"
              :title="'„É°„Éã„É•„Éº„ÇíÈñã„Åè'"
            >
              <svg
                :class="SONG_ROW_STYLES.menuButton.iconDesktop"
                fill="currentColor"
                viewBox="0 0 24 24"
              >
                <path :d="SONG_ROW_ICONS.menu" />
              </svg>
            </button>
          </div>

          <!-- „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„ÉºÔºàTeleportÔºâ -->
          <Teleport to="body">
            <div
              v-if="isMenuOpen(song.id)"
              :style="{
                top: `${menuPosition.top}px`,
                left: `${menuPosition.left}px`,
              }"
              :class="SONG_ROW_STYLES.contextMenu.container"
              @click.stop
              data-song-menu
            >
              <!-- „Éó„É¨„Ç§„É™„Çπ„Éà„Å´ËøΩÂä† -->
              <button
                @click="handleMenuAction(() => addToPlaylist(song))"
                :class="SONG_ROW_STYLES.contextMenu.menuItem"
              >
                <svg
                  :class="SONG_ROW_STYLES.contextMenu.iconPurple"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    :d="SONG_ROW_ICONS.playlist"
                  />
                </svg>
                <span>„Éó„É¨„Ç§„É™„Çπ„Éà„Å´ËøΩÂä†</span>
              </button>

              <!-- Ê•ΩÊõ≤Ë©≥Á¥∞„ÇíÈñã„Åè -->
              <NuxtLink
                :to="`/songs/${song.id}`"
                @click="closeMenu"
                :class="SONG_ROW_STYLES.contextMenu.menuItem"
              >
                <svg
                  :class="SONG_ROW_STYLES.contextMenu.iconBlue"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    :d="SONG_ROW_ICONS.info"
                  />
                </svg>
                <span>Ê•ΩÊõ≤Ë©≥Á¥∞„ÇíÈñã„Åè</span>
              </NuxtLink>

              <!-- YouTube„ÅßÈñã„Åè -->
              <a
                :href="getStreamYoutubeUrl(song)"
                target="_blank"
                rel="noopener noreferrer"
                @click="closeMenu"
                :class="SONG_ROW_STYLES.contextMenu.menuItem"
              >
                <svg
                  :class="SONG_ROW_STYLES.contextMenu.iconRed"
                  fill="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path :d="SONG_ROW_ICONS.youtube" />
                </svg>
                <span>YouTube„ÅßÈñã„Åè</span>
              </a>
            </div>
          </Teleport>
        </div>
      </div>

      <!-- Ê•ΩÊõ≤„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà -->
      <div v-else class="p-4 text-center">
        <p class="text-sm text-gray-500">
          <span v-if="stream.songs_count === 0"
            >„Åì„ÅÆÊ≠åÊû†„Å´„ÅØÊ•ΩÊõ≤„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</span
          >
          <span v-else>„Åì„ÅÆÊ≠åÊû†„ÅÆÊ•ΩÊõ≤ÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</span>
        </p>
      </div>
    </div>
  </div>

  <!-- „Éó„É¨„Ç§„É™„Çπ„ÉàËøΩÂä†„É¢„Éº„ÉÄ„É´ -->
  <Teleport to="body">
    <AddToPlaylistModal
      v-if="showPlaylistModal && selectedSong"
      :is-open="showPlaylistModal"
      :song="selectedSong"
      @close="showPlaylistModal = false"
      @added="handlePlaylistAdded"
    />
  </Teleport>
</template>

<script setup lang="ts">
  import { ref, watch } from "vue";
  import { usePlayerStore } from "~/stores/player";
  import { usePlayerQueue } from "~/stores/usePlayerQueue";
  import type { Song } from "~/types/song";
  import {
    SONG_ROW_STYLES,
    songRowUtils,
    SONG_ROW_ICONS,
  } from "~/constants/songRowStyles";
  import {
    useSongRowMenu,
    useSongRowActions,
  } from "~/composables/useSongRowMenu";

  const props = defineProps({
    stream: {
      type: Object,
      required: true,
    },
  });

  // „Ç§„Éô„É≥„Éà„ÅÆÂÆöÁæ©
  defineEmits(["view-songs", "add-stream-to-queue"]);

  // „É™„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éá„Éº„Çø
  const isExpanded = ref(false);
  const addingToQueue = ref(false);
  const streamSongs = ref<Song[]>([]);
  const loadingSongs = ref(false);
  const songsError = ref<string | null>(null);

  // „Çπ„Éà„Ç¢
  const playerStore = usePlayerStore();
  const queueStore = usePlayerQueue();

  // „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„ÉºÁÆ°ÁêÜÔºàÂÖ±ÈÄöÂåñÔºâ
  const {
    openMenuId,
    menuPosition,
    showPlaylistModal,
    selectedSong,
    openMenu,
    closeMenu,
    handleMenuAction,
    openPlaylistModal,
    handlePlaylistAdded,
    isMenuOpen,
  } = useSongRowMenu("streamSongMenuId");

  // Ê•ΩÊõ≤Êìç‰ΩúÔºàÂÖ±ÈÄöÂåñÔºâ
  const {
    playNow,
    addToQueue: addToQueueCommon,
    getYoutubeUrl,
  } = useSongRowActions();

  // Â±ïÈñã/Êäò„Çä„Åü„Åü„ÅøÂàá„ÇäÊõø„Åà
  const toggleExpanded = async () => {
    isExpanded.value = !isExpanded.value;

    // ÂàùÂõûÂ±ïÈñãÊôÇ„Å´Ê•ΩÊõ≤„ÇíË™≠„ÅøËæº„Åø
    if (isExpanded.value && streamSongs.value.length === 0) {
      await loadStreamSongs();
    }
  };

  // Ê≠åÊû†„ÅÆÊ•ΩÊõ≤„ÇíË™≠„ÅøËæº„Åø
  const loadStreamSongs = async () => {
    loadingSongs.value = true;
    songsError.value = null;

    try {
      // Êñ∞„Åó„ÅÑvideoË©≥Á¥∞„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„Çí‰ΩøÁî®„Åó„Å¶Ê•ΩÊõ≤„Éá„Éº„Çø„ÇíÂèñÂæó
      const response = await $fetch(`/api/videos/${props.stream.id}`);
      streamSongs.value = response.songs || [];
    } catch (error: any) {
      songsError.value = error.message || "Ê•ΩÊõ≤„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü";
      console.error("Failed to load stream songs:", error);
    } finally {
      loadingSongs.value = false;
    }
  };

  // Ê≠åÊû†ÂÖ®‰Ωì„Çí„Ç≠„É•„Éº„Å´ËøΩÂä†
  const handleAddStreamToQueue = async () => {
    if (addingToQueue.value) return;

    addingToQueue.value = true;

    try {
      // Ê•ΩÊõ≤„Åå„Åæ„Å†Ë™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØË™≠„ÅøËæº„ÇÄ
      if (streamSongs.value.length === 0) {
        await loadStreamSongs();
      }

      if (streamSongs.value.length > 0) {
        // Ê•ΩÊõ≤„Çí„Ç≠„É•„Éº„Å´ËøΩÂä†ÔºàvideoÊÉÖÂ†±„ÇíË£úÂÆåÔºâ
        const songsAdded = streamSongs.value.length;
        streamSongs.value.forEach((song) => {
          const songWithVideo = {
            ...song,
            video: {
              id: props.stream.id,
              title: props.stream.title,
              thumbnail_path: props.stream.thumbnail_path,
              url: props.stream.url,
              is_open: props.stream.is_open,
              is_member_only: props.stream.is_member_only,
              is_stream: props.stream.is_stream,
              unplayable: props.stream.unplayable,
              published_at: props.stream.published_at,
            },
            addedFrom: "stream" as const,
          };
          queueStore.addToQueue(songWithVideo);
        });

        // ÊàêÂäü„ÅÆ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
        console.log(
          `Added ${songsAdded} songs from stream "${props.stream.title}" to queue`
        );

        // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÅÆ„Åü„ÇÅ„ÅÆÁü≠„ÅÑ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        setTimeout(() => {
          addingToQueue.value = false;
        }, 800); // Â∞ë„ÅóÈï∑„ÇÅ„Å´Ë®≠ÂÆö„Åó„Å¶ÊàêÂäüÊÑü„ÇíÊºîÂá∫
      } else {
        addingToQueue.value = false;
        const message =
          props.stream.songs_count === 0
            ? "„Åì„ÅÆÊ≠åÊû†„Å´„ÅØÊ•ΩÊõ≤„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì"
            : "„Åì„ÅÆÊ≠åÊû†„ÅÆÊ•ΩÊõ≤ÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü";
        alert(message);
      }
    } catch (error) {
      addingToQueue.value = false;
      console.error("Failed to add stream to queue:", error);
      alert("„Ç≠„É•„Éº„Å∏„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
    }
  };

  // Ê•ΩÊõ≤„Çí‰ªä„Åô„ÅêÂÜçÁîü
  const handlePlayNow = (song: Song) => {
    // videoÊÉÖÂ†±„ÇíË£úÂÆå
    const songWithVideo = {
      ...song,
      video: {
        id: props.stream.id,
        title: props.stream.title,
        thumbnail_path: props.stream.thumbnail_path,
        url: props.stream.url,
        is_open: props.stream.is_open,
        is_member_only: props.stream.is_member_only,
        is_stream: props.stream.is_stream,
        unplayable: props.stream.unplayable,
        published_at: props.stream.published_at,
      },
      addedFrom: "stream" as const,
    };

    // „É¶„Éº„Ç∂„Éº„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥Ë®òÈå≤
    playerStore.setUserInteracted(true);

    // Êñ∞„Åó„ÅÑ„Ç≠„É•„Éº„Å®„Åó„Å¶Ë®≠ÂÆö„Åó„Å¶Âç≥Â∫ß„Å´ÂÜçÁîü
    queueStore.setQueue([songWithVideo]);
    queueStore.play(0); // „Åì„Çå„ÅåÂÜÖÈÉ®ÁöÑ„Å´playCurrentTrack()„ÇíÂëº„Å≥Âá∫„Åô„Åü„ÇÅ„ÄÅplayer.play()„ÅØ‰∏çË¶Å
  };

  // „Éó„É¨„Ç§„É™„Çπ„Éà„Å´ËøΩÂä†Ôºàcomposable„ÅÆopenPlaylistModal„Çí‰ΩøÁî®Ôºâ
  const addToPlaylist = (song: Song) => {
    // videoÊÉÖÂ†±„ÇíË£úÂÆå
    const songWithVideo = {
      ...song,
      video: {
        id: props.stream.id,
        title: props.stream.title,
        thumbnail_path: props.stream.thumbnail_path,
        url: props.stream.url,
        is_open: props.stream.is_open,
        is_member_only: props.stream.is_member_only,
        is_stream: props.stream.is_stream,
        unplayable: props.stream.unplayable,
        published_at: props.stream.published_at,
      },
      addedFrom: "stream" as const,
    };
    openPlaylistModal(songWithVideo);
  };

  // YouTube URLÁîüÊàêÔºàStreamRowÂ∞ÇÁî®ÔºöÈñãÂßãÊôÇÈñì‰ªò„ÅçÔºâ
  const getStreamYoutubeUrl = (song: Song) => {
    return getYoutubeUrl(props.stream.url, song.start_at);
  };

  // Ê•ΩÊõ≤„Çí„Ç≠„É•„Éº„Å´ËøΩÂä†
  const handleAddToQueue = (song: Song) => {
    // videoÊÉÖÂ†±„ÇíË£úÂÆå
    const songWithVideo = {
      ...song,
      video: {
        id: props.stream.id,
        title: props.stream.title,
        thumbnail_path: props.stream.thumbnail_path,
        url: props.stream.url,
        is_open: props.stream.is_open,
        is_member_only: props.stream.is_member_only,
        is_stream: props.stream.is_stream,
        unplayable: props.stream.unplayable,
        published_at: props.stream.published_at,
      },
      addedFrom: "stream" as const,
    };

    queueStore.addToQueue(songWithVideo);
  };

  // „Éú„Çø„É≥„ÅÆ„Çø„Ç§„Éà„É´„ÇíÂãïÁöÑ„Å´ÁîüÊàê
  const getAddAllButtonTitle = () => {
    if (addingToQueue.value) {
      return "„Ç≠„É•„Éº„Å´ËøΩÂä†‰∏≠...";
    }
    if (
      props.stream.songs_count !== undefined &&
      props.stream.songs_count > 0
    ) {
      return `„Åì„ÅÆÊ≠åÊû†„ÅÆÂÖ®Ê•ΩÊõ≤Ôºà${props.stream.songs_count}Êõ≤Ôºâ„Çí„Ç≠„É•„Éº„Å´ËøΩÂä†`;
    }
    return "„Åì„ÅÆÊ≠åÊû†„ÅÆÂÖ®Ê•ΩÊõ≤„Çí„Ç≠„É•„Éº„Å´ËøΩÂä†";
  };

  // Êó•ÊôÇ„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÈñ¢Êï∞
  const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    return date.toLocaleDateString("ja-JP", {
      year: "numeric",
      month: "long",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit",
    });
  };

  // ÁîªÂÉèË™≠„ÅøËæº„Åø„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
  const handleImageError = (event: Event) => {
    const target = event.target as HTMLImageElement;
    target.style.display = "none";
  };
</script>

<style scoped>
  /* „Çµ„É†„Éç„Ç§„É´„ÅÆ„Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„Çí16:9„Å´Ë™øÊï¥ */
  .w-20.h-15 {
    width: 5rem;
    height: 3.75rem; /* 20 * 9/16 = 11.25, Ë™øÊï¥„Åó„Å¶15 */
  }
</style>
